EXAMPLE

12.6

12.5 Flushing and Cleaning Cache Memory 441

The macro takes the input address and truncates it to a cache line boundary. This truncation
always addresses the first double word in the cache line of an ARM1022E (see Figure 12.12).
The macro then takes the size argument and converts it from bytes to cache lines. The
macro uses the number of cache lines as a counter variable to loop through the selected
flush or clean operation, incrementing the address by a cache line size at the end of each
loop. It exits when the counter reaches zero.

IF {CPU} = "ARM920T" :LOR: \
{CPU} ‘ARM922T" :LOR: \
{CPU} ‘ARM946E-S" :LOR: \
{CPU} ‘ARM926EJ-S" :LOR: \
{CPU} = "ARM1022E" :LOR: \
{CPU} = "ARM1026EJ-S" LOR: \
{CPU} = "XSCALE" :LOR: \

{CPU} = "SA-110"

INCLUDE cache.h

adr RN 0 3; active address

size RN 1 3 size of region in bytes

nl RN 1. 5 number of cache lines to clean or flush
MACRO.

CACHEBYREGION $op

BIC adr, adr, #(1<<CLINE)-1 3 clip 2 cline adr
MOV nl, size, Isr #CLINE 3 bytes to cline
10
IF "$op" = "IcacheFlush"

MCR p15, 0, adr, c7, c5, 1 flush I-cline@adr

ENDIF
IF "$op" = "DcacheFlush"
MCR p15, 0, adr, c7, c6, 1 3 flush D-cline@adr
ENDIF
IF "$op" = "IDcacheFlush"
MCR p15, 0, adr, c7, c5, 1 3 flush I-cline@adr
MCR p15, 0, adr, c7, c6, 1 3 flush D-cline@adr
ENDIF

IF "$op" = "DcacheClean"

MCR p15, 0, adr, c7, cl0, 1 5 clean D-cline@adr
ENDIF
IF "Sop" = "DcacheCleanFlush"

IF {CPU} = "XSCALE" :LOR: \