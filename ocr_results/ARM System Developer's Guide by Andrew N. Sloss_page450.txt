12.5 Flushing and Cleaning Cache Memory 437

IF {CPU} = "XSCALE" :LOR: {CPU} = "SA-110"
EXPORT cleanDCache
EXPORT cleanFlushDCache
EXPORT cleanFlushCache
INCLUDE cache.h

CleanAddressDcache EQU 0x8000 ;(32K block 0x8000-0x10000)
CleanAddressMiniDcache EQU 0x10000 ;(2K block 0x10000-0x10800)

adr RN O 3; start address
nl RN 1. 5 number of cache lines to process
tmp RN 12 3; scratch register

MACRO.

CACHECLEANXSCALE $op

IF "$op" = "Dclean"
LDR adr, =CleanAddressDcache
MOV onl, #(1<< (NWAY+NSET))

ENDIF

IF "$op" = "DcleanMiniÂ®
LDR adr, _=CleanAddressMiniDcache
MOV onl, #(1-<< (MNWAY+NSET) )

ENDIF
5
IF {CPU} = "XSCALE" :LAND: "$op" = "Dclean"
MCR pl5, 0, adr, c7, c2, 5 3 allocate d-cline
ADD adr, adr, #32 3 +1 d-cline
ENDIF
IF {CPU} = "SA-110" :LOR: "$op"= "DcleanMini"
LOR tmp, [adr] , #32 ; Load data, +1 d-cline
ENDIF
suBS nl, nl, #1 3 -1 loop count
BNE %BT5
IF {CPU} = "XSCALE"
CPWAIT
ENDIF
MEND
cleanDCache

CACHECLEANXSCALE Dclean
MOV pc, Ir