11.2 Example: Simple Little Operating System 397

11.2.6.1 Save the Current Context

The first stage is to save the current registers of the active task ¢. All tasks execute in user
mode, so the user mode registers have to be saved. Here is the procedure:

1. We must restore registers r0 to r3 and r14 from the stack. These registers belong to the
current task.

2. Register r13 is then used to point into the PCB of the current task PCB_CurrentTask
offset by —60. This offset allows two instructions to update the entire PCB.

3. The final action of the first stage is to store all the user bank registers r0 to r14. This occurs
in a single instruction. Remember that the * symbol means that the store multiple acts
on the user mode registers. The second store instruction saves the spsr and the returning
link register.

The code for saving the registers to a PCB is
Offset15Regs EQU 15*4

handler_contextswitch
LOMFD r13!,{r0-r3,r12,r14} —; [1.1] restore registers
LOR —r13,=PCB_PtrCurrentTask ; [1.2]
LOR —r3, [r13] r13=mem32[r13]
SUB —r13,r13,#0ffset15Regs ;_r13-=15*Reg:place r13
STMIA 13, {r0-r14}* ; [1.3] save user mode registers
MRS 0, spsr copy spsr
STMDB. 13, {r0,r14} save r0(spsr) & r14(Ir)

The results of saving the current context are the following:

= The IRQ stack is reset and saved to PCB_IRQStack.

= The user mode registers for task tare saved to the current PCB.

11.2.6.2 Load the Next Context

The second stage of the context switch involves transferring the PCB for ¢’ into the banked
user mode registers. Once complete, the routine then must hand over control to the new
task ¢. Here is the procedure:

1. Load and position register r13 at offset —60 from the start of the new PCB.

2. Load register spsr and the link register first. Then the next task registers r0 to rl4 are
loaded. Register r14 is the user bank register r14, not the IRQ register rl4 shown by * in
the instruction.